# 2. 詳細設計（理論）

本節では、LSTM–PSO ハイブリッドモデルが為替時系列の1期先対数収益予測において有効である理由を、理論的に整理する。

各構成要素（前処理・LSTM・PSO・補助特徴量）の選択理由を、金融時系列の統計的性質と機械学習の理論に基づいて論じる。

---

## 2.1 問題の定式化と金融時系列の統計的性質

### 2.1.1 予測問題の定式化

対象とする予測問題を次のように定式化する。

**目的変数**

$$
y_t = \ln\frac{P_{t+1}}{P_t}
$$

- $P_t$: 時点 $t$ の USD/JPY 終値
- $y_t$: 1期先の対数収益（リターン）

**説明変数**

$$
\mathbf{x}_{t-L+1:t} = (\mathbf{x}_{t-L+1},\, \ldots,\, \mathbf{x}_t)
$$

- 時点 $t$ およびそれ以前に観測可能な情報のみから構成される特徴ベクトルのシーケンス
- $L$: ルックバック長

**最適化手法**

$$
\min_{f,\,\theta} \;\mathbb{E}\left[\,\bigl(y_t - \hat{y}_t\bigr)^2 \;\mid\; \mathbf{x}_{t-L+1:t}\,\right], \qquad \hat{y}_t = f(\mathbf{x}_{t-L+1:t};\,\theta)
$$

学習データから予測関数 $f$ とパラメータ $\theta$ を推定し、条件付き期待二乗誤差（RME）を最小化する。

この定式化では、$y_t$ が「$t$ 時点の情報までを用いた、$t+1$ 時点のリターン予測」に対応するため、実運用上の解釈（現時点で得られる情報に基づく翌足の方向・大きさの予測）と一致する。

---

### 2.1.2 金融時系列の統計的性質と学習理論上の含意

為替・株価などの価格時系列は、一般の時系列モデルが仮定する定常性や線形性から外れた性質を持つ。そのことが予測モデルの設計と評価に直結する。

**定常性・非定常性の補足**

| **項目** | **定常 (Stationary)** | **非定常 (Non-stationary)** |
| --- | --- | --- |
| **統計的性質** | 一定（平均・分散が不変） | 変化する（トレンドや季節性あり） |
| **予測の難易度** | 比較的容易 | 困難（モデルの更新が必要） |
| **主なリスク** | 突発的な外乱 | 長期的なドリフト、容量不足 |
| **設計時の対策** | 標準的なバッファ確保 | スケーラビリティの確保、動的制御 |

---

#### (1) 非定常性と「スケールの比率」の定常性

価格水準 $P_t$ はトレンドやレジームシフトにより非定常であり、そのままでは学習期とテスト期で分布がずれて汎化しにくい。そこで、**一定期間のあいだは価格が幾何ブラウン運動（GBM）に従う**と仮定する。

幾何ブラウン運動では $dP_t = \mu P_t\,dt + \sigma P_t\,dW_t$ であり、離散時の対数収益は

$$
\ln\frac{P_{t+1}}{P_t} = y_t
$$

と書ける。この仮定の下では、ドリフト・拡散が一定とみなせる範囲で **対数収益（および価格同士の対数比率）は定常に近い**と扱える。つまり「水準 $P_t$ は非定常だが、スケールの比率（対数収益・対数比率）は定常性を持つ」とみなす。

したがって、モデルへの入力は価格水準ではなく、**対数収益や終値との対数乖離**に限定する。これにより、分布の時間不変性を仮定しうる空間に問題を写し、汎化と最適化の両面を改善する。

---

#### (2) ノイズとシグナル

高頻度価格 $P_t$ には観測ノイズやマイクロ構造に起因する変動が含まれる。これらは本質的な「予測可能な成分」ではなく、サンプル外では再現しない。

ノイズが相対的に大きいと、モデルはノイズにフィットし、真の条件付き期待

$$
\mathbb{E}[y_t \mid \mathbf{x}_{t-L+1:t}]
$$

の推定がバイアス・分散ともに悪化する。

**理論的な対応**: 多解像度分解（ウェーブレット変換）により高周波成分を抑え、低周波のスムースな成分を主に予測に用いる。シグナル／ノイズ比を改善する。

---

#### (3) 非線形性と長期依存

リターン $y_t$ と過去の情報との関係は、線形自己回帰では不十分な場合が多い。テクニカル指標と価格の関係、ボラティリティとリターンの関係などは非線形であり、「何本前の値が効くか」がデータに依存する長期依存もありうる。

**理論的な対応**: 非線形関数近似能力と、長い系列に対する勾配の伝播を保ちうるリカレント構造（LSTM）を用い、非線形かつ長期の依存を表現可能にする。

---

#### (4) ボラティリティの時間的相関（クラスタリング）

条件付き分散は時点によって大きく異なり、連続する時点間で相関する（大きな変動の後に大きな変動が続きやすい）。

$$
\mathrm{Var}(y_t \mid \mathcal{F}_{t-1}) \;\text{は}\; t \; \text{に強く依存し、時系列相関を持つ}
$$

このため、入力や目的変数のスケールが時期によって変動する。全期間で同一の平均・分散を用いる固定標準化では、ローカルなスケール変化を反映できず、学習や評価が歪む。

**理論的な対応**: 時点 $t$ において、$t$ 以前の情報のみを用いたローリングな標準化（例: EWMA に基づく平均・分散）を施す。ボラティリティの時間変化を局所的に吸収し、モデル入力を「スケールが安定した空間」に写す。

---

#### (5) 極端な外れ値（厚い裾）

金融リターンは正規分布より裾が厚く、稀に極端な値が観測される。

これらをそのまま用いると、二乗誤差損失の下で外れ値が勾配を支配し、推定が数少ない極端事象に引きずられる。標準化の際に分散の推定が外れ値で膨らみ、通常時のスケールが圧縮される。

**理論的な対応**: 標準化の前に、ローリングな尺度（例: EWMA 標準偏差の 3 倍）を超える値をクリップする。損失とスケール推定の両方において外れ値の影響を有界にし、ロバストな学習と評価を可能にする。

---

#### (6) カレンダー効果（周期性）

取引時間・曜日により流動性やボラティリティが変化する。曜日や時間を無視すると、同じ数値が異なる「文脈」（例: 月曜 9 時と金曜 22 時）で同一に扱われ、モデルが文脈を利用できない。

**理論的な対応**: 曜日・時間を連続かつ周期を保つ形で符号化する（例: sin/cos エンコーディング）。周期のつながり（例: 日曜 23 時と月曜 0 時が近い）を表現しつつ、モデルがカレンダー効果を非線形に利用できるようにする。

---

**まとめ**: 「定常に近い変換」「ノイズ低減」「非線形・長期依存のモデル化」「局所スケール・外れ値の扱い」「周期の明示」が、金融時系列の性質に理論的に整合した設計として要請される。

---

## 2.2 モデル構成要素の理論的根拠

### 2.2.1 LSTM の有効性

**長期依存の扱い**

単純な RNN では、長いシーケンスにわたる勾配が消失または爆発し、遠い過去の情報が実質的に学習に寄与しにくい。

LSTM はゲート（忘却・入力・出力）によりセル状態の更新を制御し、勾配が時間方向に安定して伝播しうる構造を持つ。この性質により、為替のように「数十～百本前」のパターンが効く可能性がある系列でも、その依存を学習可能になる。

**非線形性**

各セルは非線形写像の積み重ねであり、リターンと過去の特徴量との非線形な関係（テクニカル指標の閾値効果、複数指標の交互作用など）を表現できる。線形モデルでは捉えにくい、条件付き平均の曲率や非対称性をモデルに含められる。

**ハイパーパラメータの重要性**

隠れユニット数・層数・学習エポック数は、モデルの容量と過学習のトレードオフを決める。これらが不適切だと underfitting または overfitting により汎化誤差が悪化する。検証データに基づく体系的な探索が理論的にも必要となる。

---

### 2.2.2 PSO によるハイパーパラメータ探索の有効性

**目的関数の性質**

検証 RMSE は、ハイパーパラメータに対して微分可能でない（離散的な層数・エポック数を含む）うえ、ノイズがあり多峰性もありうる。勾配に基づく最適化は直接は適用しにくい。

$$
\text{目的関数:}\quad \mathrm{RMSE}_{\mathrm{val}}(\theta_{\mathrm{hp}}), \qquad \theta_{\mathrm{hp}} = (\text{ユニット数},\, \text{層数},\, \text{エポック数})
$$

**PSO の適性**

粒子群最適化（PSO）は目的関数の勾配を必要とせず、離散・連続が混在する探索空間にも適用できる。複数粒子が並列に評価されるため、局所解に張り付きにくく、検証誤差を目的関数とする場合のノイズにもある程度ロバストである。LSTM のユニット数・層数・エポック数を同時に探索する組み合わせ最適化に理論的に適合している。

**探索コストとのトレードオフ**

粒子数と反復数を増やすほど探索は広くなるが、1 回の評価が LSTM の学習であるため計算コストが大きい。粒子数・反復数は、許容計算時間と探索の網羅性のトレードオフで設定する。

---

### 2.2.3 その他手法の理論的役割

**ウェーブレット変換（MODWT, Haar）**

信号を複数のスケール（解像度）に分解する。高周波成分にはノイズが多く、低周波成分にトレンドや持続的なシグナルが含まれる、という仮定の下で、適切なレベル（本実装では level 3）の係数を採用することでノイズを相対的に抑制する。

**重要**: 未来の情報を用いないよう、各時点で利用するのはその時点までに得られるデータのみに限定する（ローリング／時点ごとの適用）。データリークによる楽観的な評価を防ぐ。

**テクニカル指標の対数乖離**

各指標を終値との対数乖離に統一する。

$$
\text{指標}\; I_t \;\rightarrow\; \ln\frac{I_t}{P_t} \quad \text{（終値}\; P_t \;\text{との対数乖離）}
$$

(i) 水準ではなく「終値からの乖離」という定常に近い量にし、(ii) 指標間のスケールを価格変化のスケールに揃える。定常性の仮定と入力の一貫性が満たされ、LSTM の学習が安定しやすくなる。

**周期エンコーディング（dow_sin/cos, hour_sin/cos）**

曜日・時間を 0–1 の離散ラベルではなく、sin/cos で符号化する。

$$
\text{曜日}\; d \in \{0,\ldots,6\} \;\rightarrow\; \Bigl(\sin\frac{2\pi d}{7},\, \cos\frac{2\pi d}{7}\Bigr), \qquad
\text{時間}\; h \in \{0,\ldots,23\} \;\rightarrow\; \Bigl(\sin\frac{2\pi h}{24},\, \cos\frac{2\pi h}{24}\Bigr)
$$

周期の連続性（例: 23 時と 0 時の近さ）を保ち、モデルが連続値として非線形に利用できる。カレンダー効果がリターンに影響する限り、この情報は条件付き期待の推定に理論的に寄与しうる。

---

## 2.3 課題と解決策の対応（理論的対応表）

前節の議論に基づき、金融時系列の課題と、本モデルにおける理論的対応を下表にまとめる。

| 課題 | 理論的対応 | 備考 |
|------|------------|------|
| 非定常性 | 対数収益・対数乖離に変換し、定常に近いデータのみをモデルに入力する | 分布の時間不変性を仮定しうる空間への写像 |
| ノイズ | MODWT（Haar, level 3）で高周波成分を抑制し、シグナル／ノイズ比を改善する | 未来データを使わないローリング適用でリーク防止 |
| 非線形性 | LSTM の非線形写像で条件付き期待を近似する | 長期依存もゲート機構で学習可能 |
| ハイパーパラメータ | PSO で検証 RMSE を最小化するようにユニット数・層数・エポック数を探索する | 勾配不要・離散混合空間に適合 |
| ボラティリティ・クラスタリング | EWMA によるローリング標準化で局所スケールを吸収する | 時点 $t$ 以前の情報のみ使用 |
| 極端な外れ値（厚い裾） | ±3σ_ewma でクリップしてから標準化し、損失と分散推定のロバスト性を確保する | 外れ値の影響を有界化 |
| カレンダー効果 | 曜日・時間を sin/cos で周期エンコーディングし、文脈を連続的に表現する | 周期の連続性と非線形利用を両立 |

---

データの詳細定義（加工前の入力データ、加工後の説明変数一覧、目的変数の数式とシーケンス対応）は [1.3 データの概要・データの詳細定義](01_basic_design.md#13-データの概要) を参照のこと。
